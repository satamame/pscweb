# 手順メモ_03
## サインアップ時、メールアドレスを聞く
### 参考
1. [Djangoで、会員登録機能を自作する](https://torina.top/detail/288/)
    - ユーザ名の代わりにメールアドレスを使うのでなく、ユーザ名とメールアドレスの両方を必須にしたい。
1. [Django の認証方法のカスタマイズ](https://docs.djangoproject.com/ja/2.0/topics/auth/customizing/)
1. [Djangoメモ(20) : ユーザー認証を実装する〜サインアップのテストとフォームの改良](https://wonderwall.hatenablog.com/entry/2018/03/21/190000)
1. [Djangoでユーザー作成処理(仮登録後、URLクリックで本登録)](https://torina.top/detail/273/)

### 手順
- 参考3の、フォームの変更だけをやってみた。
    - ただし view はクラスなので、 form_class 変数を SignUpForm にするだけで良い。
    - サインアップ・フォームに Email フィールドが追加された。
        - テンプレートの form.as_p 部分に、form_class で定義された要素が入るっぽい。
    - Email の入力が必須となり、バリデーションも行われた。
    - サインアップすると Email も DB に保存された。
- Sign up ボタンの処理を、メール送信にする。
    - ここからは参考4に沿ってやってみる。
    - まず、よく分からないけど settings.py に MAIL_BACKEND というのを追加。
    - urls.py には以下の２個を追加。'user_create/' は 'signup/' に読み替え。
    ```
    path('user_create/done', views.UserCreateDone.as_view(), name='user_create_done'),
    path('user_create/complete/<token>/', views.UserCreateComplete.as_view(), name='user_create_complete'),
    ```
    - すでに作った class SignUpView を、参考4の class UserCreate のように変える。
        - form_class と template_name は変えない。
        - form_valid() がいろいろやってくれるので、success_url は、多分いらない。
    - class UserCreateDone と UserCreateComplete は、とりあえずコピペする。
- フォーム
    - とりあえず、参考3で作ったフォームがそのまま使えないか、やってみる。
        - 新規で追加するコードをなるべく少なく。
    - register となっているところは、accounts と読み替える。
        - views.py も、そうすべきだったので、ここで直しておく。
- テンプレート
    - メールのテンプレートを、accounts/templates/accounts 以下に作る。
    - login と sign up のテンプレートは動いてるっぽいので、とりあえずそのまま。
    - user_create_done.html をコピペ。
        - base.html は、プロジェクト直下の templates フォルダ内のを使う。
    - user_create_complete.html についても同様。

## ここまでで出来るようになったこと
- Sign-up 処理
    - SignUpView (accounts/signup/) から仮登録処理
    - トークン付きの URL を、コンソールに表示（後でメールを送信するように変更する）
    - トークン付きの URL を使ってユーザを本登録する
    - 本登録したら accounts/login/ にリダイレクト
